name: Django CI (Nexus ERP)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    # ğŸ’¡ å®šç¾©è³‡æ–™åº«æœå‹™
    services:
      db:
        image: postgres:16 # å‡ç´šåˆ°èˆ‡ Django 6.0 æ›´å¥‘åˆçš„ç‰ˆæœ¬
        env:
          POSTGRES_DB: nexus_db
          POSTGRES_USER: nexus_user
          POSTGRES_PASSWORD: nexus_password
        ports:
          - 5432:5432
        # ç¢ºä¿è³‡æ–™åº«å®Œå…¨å•Ÿå‹•å¾Œæ‰é–‹å§‹ Step
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4 # å‡ç´šåˆ° v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ğŸ’¡ å°ˆæ¥­æ¨è–¦ï¼šä½¿ç”¨å®˜æ–¹ uv-actionï¼Œè™•ç†é€Ÿåº¦æœ€å¿«ä¸”æ”¯æ´å¿«å–
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          # å¦‚æœä½ æœ‰é¡å¤–çš„æ¸¬è©¦å¥—ä»¶ (å¦‚ pytest-django)
          # uv pip install --system pytest

      - name: Run Tests
        env:
          # ğŸ’¡ æ ¸å¿ƒä¿®æ­£ï¼šå°‡è³‡æ–™åº«é€£ç·šè³‡è¨Šé€éç’°å¢ƒè®Šæ•¸æ³¨å…¥
          DATABASE_URL: postgres://nexus_user:nexus_password@localhost:5432/nexus_db
          REDIS_URL: redis://localhost:6379/1
          DEBUG: "True"
          SECRET_KEY: "ci-test-key-for-nexus-erp"
        run: |
          # æ ¹æ“šä½ çš„ç›®éŒ„çµæ§‹ï¼Œmanage.py æ‡‰è©²åœ¨æ ¹ç›®éŒ„
          python manage.py test apps/
